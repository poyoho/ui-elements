import{g as e,c as t,d as n,m as r,e as o,w as a,f as s,h as i,r as p}from"./resolvePackage.fdc5f42d.js";import{M as c,a as f}from"./vendor.3da8fb95.js";const l=e=>"ObjectProperty"===e.type&&!e.computed;function d(e,p,d,u=t){const _=new c(p),g=n(p,{sourceFilename:e,sourceType:"module",plugins:u}).program.body,v=new Map,w=new Set,$=new Set,h=new Map;function b(e,t){const n=t.replace(/^\.\/+/,"");if(!d.isExist(n))throw new Error(`File "${n}" does not exist.`);if($.has(n))return h.get(n);$.add(n);const r=`__import_${$.size}__`;return h.set(n,r),_.appendLeft(e.start,`const ${r} = ${s}[${JSON.stringify(n)}]\n`),r}function A(e,t=e){_.append(`\n${o}(${r}, "${e}", () => ${t})`)}_.prepend(`const ${r} = __modules__[${JSON.stringify(e)}] = { [Symbol.toStringTag]: "Module" }\n\n`);for(const t of g)if("ImportDeclaration"===t.type){if(t.source.value.startsWith("./")){const e=b(t,t.source.value);for(const n of t.specifiers)"ImportSpecifier"===n.type?v.set(n.local.name,`${e}.${n.imported.name}`):"ImportDefaultSpecifier"===n.type?v.set(n.local.name,`${e}.default`):v.set(n.local.name,e);_.remove(t.start,t.end)}}for(const t of g){if("ExportNamedDeclaration"===t.type)if(t.declaration){if("FunctionDeclaration"===t.declaration.type||"ClassDeclaration"===t.declaration.type)A(t.declaration.id.name);else if("VariableDeclaration"===t.declaration.type)for(const e of t.declaration.declarations){const t=m(e.id).map((e=>e.name));for(const e of t)A(e)}_.remove(t.start,t.declaration.start)}else if(t.source){const e=b(t,t.source.value);for(const n of t.specifiers)A(n.exported.name,`${e}.${n.local.name}`);_.remove(t.start,t.end)}else{for(const e of t.specifiers){const t=e.local.name,n=v.get(t);A(e.exported.name,n||t)}_.remove(t.start,t.end)}if("ExportDefaultDeclaration"===t.type&&_.overwrite(t.start,t.start+14,`${r}.default =`),"ExportAllDeclaration"===t.type){const e=b(t,t.source.value);_.remove(t.start,t.end),_.append(`\nfor (const key in ${e}) {\n        if (key !== 'default') {\n          ${o}(${r}, key, () => ${e}[key])\n        }\n      }`)}}for(const t of g)"ImportDeclaration"!==t.type&&a(t,((e,t,n)=>{const r=v.get(e.name);if(r)if(l(t)&&t.shorthand)t.inPattern&&!y(t,n)||_.appendLeft(e.end,`: ${r}`);else if("ClassDeclaration"===t.type&&e===t.superClass){if(!w.has(e.name)){w.add(e.name);const t=n[1];_.prependRight(t.start,`const ${e.name} = ${r};\n`)}}else _.overwrite(e.start,e.end,r)}));return f(g,{enter(e,t){if("Import"===e.type&&"CallExpression"===t.type){const n=t.arguments[0];"StringLiteral"===n.type&&n.value.startsWith("./")&&(_.overwrite(e.start,e.start+6,i),_.overwrite(n.start,n.end,JSON.stringify(n.value.replace(/^\.\/+/,""))))}}}),{code:_.toString(),importedFiles:$}}function u(t,n,r=new Map){if(r.has(t))return;const{js:o,css:a}=t.compiled,{code:s,importedFiles:i}=d(t.filename,o,n),{code:p}=function(t,n,r){return{code:n?`\n${e} += ${JSON.stringify(n)}`:""}}(t.filename,a),c=s+p;for(const e of i)u(n.readFile(e),n,r);r.set(t,c)}function m(e,t=[]){switch(e.type){case"Identifier":t.push(e);break;case"MemberExpression":let n=e;for(;"MemberExpression"===n.type;)n=n.object;t.push(n);break;case"ObjectPattern":e.properties.forEach((e=>{"RestElement"===e.type?m(e.argument,t):m(e.value,t)}));break;case"ArrayPattern":e.elements.forEach((e=>{e&&m(e,t)}));break;case"RestElement":m(e.argument,t);break;case"AssignmentPattern":m(e.left,t)}return t}function y(e,t){if(e&&("ObjectProperty"===e.type||"ArrayPattern"===e.type)){let e=t.length;for(;e--;){const n=t[e];if("AssignmentExpression"===n.type)return!0;if("ObjectProperty"!==n.type&&!n.type.endsWith("Pattern"))break}}return!1}function _(e,t,n){return u(e,t,n)}async function g(e){const t=await p("vue","3.2.6"),n=new Map,r=()=>["window.__modules__ = {};window.__css__ = ''",...Array.from(n.values()),"\r\nimport { createApp as _createApp } from \"vue\"\r\n\r\nconst App = __modules__[\"app.vue\"].default\r\nconst config = __modules__[\"config.ts\"].default\r\n\r\nif (window.__app__) {\r\n  window.__app__.unmount()\r\n  document.getElementById('app').innerHTML = ''\r\n}\r\ndocument.getElementById('__sfc-styles').innerHTML = window.__css__\r\n\r\nconst app = window.__app__ = _createApp(App)\r\napp.config.errorHandler = e => console.error(e)\r\n\r\nawait config.enhanceApp(app)\r\n\r\napp.mount('#app')\r\n\r\n"],o={entryFile:"app.vue",configFile:"config.ts",defaultConfigCode:["const config: AppUserConfig = {","  // init vue app","  enhanceApp (app) {}","}","export default config"].join("\n"),importMap:{vue:"3.2.6"},dts:t.concat([{filePath:"index.d.ts",content:"interface AppUserConfig {\r\n  enhanceApp: (app: import(\"vue\").App) => void\r\n}\r\n\r\ndeclare module '*.vue' {\r\n  import { DefineComponent } from 'vue'\r\n  const component: DefineComponent<{}, {}, any>\r\n  export default component\r\n}\r\n"}]),reload(){const t=e.readFile(o.configFile),a=e.readFile(o.entryFile);return n.clear(),_(t,e,n),_(a,e,n),r()},update:t=>n.size?(n.delete(t),_(t,e,n),r()):o.reload()};return o}export{g as createVueProject};
